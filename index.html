<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Califonix | Pro Production Station v2.0</title>
    <style>
        :root { 
            --bg: #000000; --card: #0c0c0c; --accent: #00f2ff; 
            --pass: #00ff66; --fail: #ff0044; --low: #ffaa00; --text: #ffffff;
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: var(--bg); color: var(--text); 
            margin: 0; overflow: hidden; height: 100vh;
            display: flex; flex-direction: column;
        }

        #blink-layer {
            position: fixed; inset: 0; z-index: 9999;
            pointer-events: none; opacity: 0; transition: 0.2s;
        }

        .flash-green { animation: flash-g 0.6s infinite; }
        .flash-red { animation: flash-r 0.6s infinite; }

        @keyframes flash-g { 50% { opacity: 0.2; background: var(--pass); } }
        @keyframes flash-red { 50% { opacity: 0.2; background: var(--fail); } }

        .header { display: flex; justify-content: space-between; align-items: center; padding: 10px 30px; background: #080808; border-bottom: 1px solid #222; }
        .logo { height: 40px; }

        .main-container { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        
        .model-header { text-align: center; margin-bottom: 30px; }
        .model-name { font-size: 70px; font-weight: 900; margin: 0; letter-spacing: -2px; }
        .limit-pill { background: rgba(0, 242, 255, 0.1); border: 1px solid var(--accent); color: var(--accent); padding: 5px 20px; border-radius: 50px; font-weight: bold; }

        .grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; width: 95%; max-width: 1400px; }
        .card { background: var(--card); border: 1px solid #222; border-radius: 20px; padding: 40px 20px; text-align: center; position: relative; }
        .card-label { font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 20px; }
        
        .val-mA { font-size: 100px; font-weight: bold; color: var(--accent); }
        .val-mac { font-size: 38px; font-family: 'Courier New', Courier, monospace; }
        .val-status { font-size: 60px; font-weight: 900; }

        .status-ready { color: #333; }
        .status-testing { color: var(--accent); animation: blink 1s infinite; }
        .status-pass { color: var(--pass); }
        .status-fail { color: var(--fail); }

        @keyframes blink { 50% { opacity: 0.3; } }

        .stats-footer { background: #050505; padding: 15px 40px; border-top: 1px solid #111; display: flex; justify-content: space-between; font-size: 18px; }
        
        /* OVERLAY SETUP */
        #overlay { position: fixed; inset: 0; background: #000; z-index: 10000; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 20px; }
        .setup-btn { width: 400px; padding: 20px; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.3s; }

        /* DEBUG PANEL */
        #debug-panel { height: 100px; background: #050505; border-top: 1px solid #222; padding: 10px; font-family: monospace; font-size: 11px; overflow-y: auto; color: #444; }

        .modal { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#111; padding:30px; border-radius:15px; border:1px solid #333; z-index: 11000; width: 350px; }
        input { width: 100%; padding: 10px; margin: 10px 0; background: #000; border: 1px solid #333; color: white; border-radius: 5px; box-sizing: border-box; }
    </style>
</head>
<body>

    <div id="blink-layer"></div>

    <!-- STARTUP DIALOG -->
    <div id="overlay">
        <h1 style="margin-bottom: 30px;">STATION INITIALIZATION</h1>
        <button id="btnESP" class="setup-btn" style="background: #e67e22;" onclick="connectESP()">1. CONNECT CURRENT SENSOR</button>
        <button id="btnBB" class="setup-btn" style="background: #3498db; display:none;" onclick="connectBB()">2. CONNECT MAC BOX</button>
        <button id="btnPath" class="setup-btn" style="background: #2ecc71; display:none;" onclick="setupFolder()">3. SELECT LOGS FOLDER</button>
    </div>

    <div class="header">
        <img src="https://i.postimg.cc/5y7SN4xc/logo.png" class="logo">
        <div style="font-weight: bold; color: #444;">CALIFONIX INDUSTRIAL PRO v2.0</div>
        <button onclick="openConfig()" style="background:#222; border:none; color:white; padding:5px 15px; border-radius:5px; cursor:pointer;">CONFIG</button>
    </div>

    <div class="main-container">
        <div class="model-header">
            <h1 id="dispModel" class="model-name">--</h1>
            <span id="dispLimits" class="limit-pill">RANGE: -- to -- mA</span>
        </div>

        <div class="grid">
            <div class="card">
                <div class="card-label">Hardware MAC Address</div>
                <div id="mac" class="val-mac">WAITING...</div>
            </div>
            <div class="card">
                <div class="card-label">Real-time Current (mA)</div>
                <div id="dispCurrent" class="val-mA">0.0</div>
            </div>
            <div class="card">
                <div class="card-label">Process Status</div>
                <div id="status" class="val-status status-ready">READY</div>
                <div id="timer" style="margin-top:10px; font-family:monospace; color:#444;">0.0s</div>
            </div>
        </div>
    </div>

    <div class="stats-footer">
        <div>TOTAL: <span id="s-total">0</span></div>
        <div style="color: var(--pass);">PASS: <span id="s-pass">0</span></div>
        <div style="color: var(--fail);">FAIL: <span id="s-fail">0</span></div>
    </div>

    <div id="debug-panel">--- SYSTEM LOGS ---<br></div>

    <!-- CONFIG MODAL -->
    <div id="configModal" class="modal">
        <h3 style="color:var(--accent)">Station Config</h3>
        <label>Model Name</label><input id="in-model">
        <label>Min mA</label><input id="in-min" type="number">
        <label>Max mA</label><input id="in-max" type="number">
        <label>Zero Offset</label><input id="in-offset" type="number">
        <label>Cal Multiplier</label><input id="in-cal" type="number" step="0.001">
        <button onclick="saveConfig()" style="width:100%; padding:15px; background:var(--pass); border:none; border-radius:5px; font-weight:bold; cursor:pointer;">SAVE SETTINGS</button>
    </div>

    <script>
        let espPort, bbPort, dirHandle;
        let locked = false, testing = false, capturedMAC = null;
        let startTime, timerInterval;
        
        // Defaults if LocalStorage is empty
        let cfg = { model: "Boat 161", min: 30, max: 80, offset: 0.0, cal: 1.0 };
        let counts = { total: 0, pass: 0, fail: 0 };

        window.onload = () => {
            let saved = localStorage.getItem('cali_v2_cfg');
            if(saved) cfg = JSON.parse(saved);
            updateUIStrings();
        };

        function log(msg) {
            const dp = document.getElementById('debug-panel');
            dp.innerHTML += `> ${msg}<br>`;
            dp.scrollTop = dp.scrollHeight;
        }

        async function connectESP() {
            try {
                espPort = await navigator.serial.requestPort();
                await espPort.open({ baudRate: 115200 });
                document.getElementById('btnBB').style.display = "block";
                log("Current Sensor Connected.");
            } catch (e) { log("Error connecting Sensor: " + e); }
        }

        async function connectBB() {
            try {
                bbPort = await navigator.serial.requestPort();
                await bbPort.open({ baudRate: 460800 });
                document.getElementById('btnPath').style.display = "block";
                log("MAC Box Connected.");
            } catch (e) { log("Error connecting MAC Box: " + e); }
        }

        async function setupFolder() {
            try {
                dirHandle = await window.showDirectoryPicker();
                document.getElementById('overlay').style.display = "none";
                log("Log folder selected. System Ready.");
                startReading();
            } catch (e) { log("Folder access denied."); }
        }

        function startReading() {
            readESP();
            readBB();
        }

        async function readESP() {
            const decoder = new TextDecoder();
            while (espPort.readable) {
                const reader = espPort.readable.getReader();
                try {
                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;
                        let text = decoder.decode(value);
                        if (text.includes("C|")) {
                            let raw = parseFloat(text.split("|")[1]);
                            let liveMA = (raw - cfg.offset) * cfg.cal;
                            if (liveMA < 2) liveMA = 0;

                            // Display
                            if (!locked) {
                                document.getElementById('dispCurrent').innerText = liveMA.toFixed(1);
                                if (liveMA > 10.0 && capturedMAC && !testing) {
                                    startTest(liveMA);
                                }
                            }

                            // Auto Reset
                            if (liveMA < 5.0 && (locked || testing)) {
                                resetUI();
                            }
                        }
                    }
                } catch (e) { log("ESP Stream Error: " + e); }
                finally { reader.releaseLock(); }
            }
        }

        async function readBB() {
            const reader = bbPort.readable.getReader();
            let buffer = [];
            try {
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    value.forEach(b => buffer.push(b));
                    while (buffer.length >= 8) {
                        let idx = buffer.indexOf(0x06);
                        if (idx !== -1 && buffer[idx+1] === 0x01 && buffer.length >= idx + 8) {
                            let mac = buffer.slice(idx+2, idx+8).map(b => b.toString(16).padStart(2, '0').toUpperCase()).join(":");
                            if(!locked && !testing) {
                                capturedMAC = mac;
                                document.getElementById('mac').innerText = mac;
                                document.getElementById('mac').style.color = "var(--accent)";
                                log("MAC Captured: " + mac);
                            }
                            buffer.splice(0, idx + 8);
                        } else if (idx === -1) { buffer = []; break; }
                        else { buffer.shift(); }
                    }
                }
            } catch (e) { log("MAC Box Error: " + e); }
            finally { reader.releaseLock(); }
        }

        function startTest(val) {
            testing = true;
            startTime = Date.now();
            document.getElementById('status').innerText = "TESTING";
            document.getElementById('status').className = "val-status status-testing";
            
            timerInterval = setInterval(() => {
                let elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
                document.getElementById('timer').innerText = elapsed + "s";
                if (elapsed >= 2.0) {
                    clearInterval(timerInterval);
                    finalizeResult();
                }
            }, 100);
        }

        async function finalizeResult() {
            if (locked) return;
            locked = true;
            let finalMA = parseFloat(document.getElementById('dispCurrent').innerText);
            let result = "PASS";
            let classStyle = "status-pass";

            if (finalMA < cfg.min) { result = "LOW mA"; classStyle = "status-fail"; }
            else if (finalMA > cfg.max) { result = "HIGH mA"; classStyle = "status-fail"; }

            document.getElementById('status').innerText = result;
            document.getElementById('status').className = "val-status " + classStyle;
            document.getElementById('blink-layer').className = (result === "PASS") ? "flash-green" : "flash-red";

            counts.total++;
            if (result === "PASS") counts.pass++; else counts.fail++;
            updateStatsUI();
            
            await saveToCSV(cfg.model, capturedMAC, finalMA, result);
        }

        async function saveToCSV(mod, mac, ma, st) {
            if (!dirHandle) return;
            try {
                const date = new Date().toISOString().split('T')[0];
                const fileHandle = await dirHandle.getFileHandle(`Log_${date}.csv`, { create: true });
                const writable = await fileHandle.createWritable({ keepExistingData: true });
                const file = await fileHandle.getFile();
                let header = (file.size === 0) ? "Date,Time,Model,MAC,Current_mA,Status\n" : "";
                const row = `${header}${new Date().toLocaleDateString()},${new Date().toLocaleTimeString()},${mod},${mac},${ma},${st}\n`;
                await writable.write({ type: 'write', position: file.size, data: row });
                await writable.close();
                log("Log saved for " + mac);
            } catch (e) { log("CSV Error: " + e); }
        }

        function resetUI() {
            clearInterval(timerInterval);
            locked = false; testing = false; capturedMAC = null;
            document.getElementById('status').innerText = "READY";
            document.getElementById('status').className = "val-status status-ready";
            document.getElementById('mac').innerText = "WAITING...";
            document.getElementById('mac').style.color = "white";
            document.getElementById('timer').innerText = "0.0s";
            document.getElementById('blink-layer').className = "";
        }

        function updateStatsUI() {
            document.getElementById('s-total').innerText = counts.total;
            document.getElementById('s-pass').innerText = counts.pass;
            document.getElementById('s-fail').innerText = counts.fail;
        }

        function updateUIStrings() {
            document.getElementById('dispModel').innerText = cfg.model;
            document.getElementById('dispLimits').innerText = `RANGE: ${cfg.min} to ${cfg.max} mA`;
        }

        function openConfig() {
            document.getElementById('in-model').value = cfg.model;
            document.getElementById('in-min').value = cfg.min;
            document.getElementById('in-max').value = cfg.max;
            document.getElementById('in-offset').value = cfg.offset;
            document.getElementById('in-cal').value = cfg.cal;
            document.getElementById('configModal').style.display = "block";
        }

        function saveConfig() {
            cfg.model = document.getElementById('in-model').value;
            cfg.min = parseFloat(document.getElementById('in-min').value);
            cfg.max = parseFloat(document.getElementById('in-max').value);
            cfg.offset = parseFloat(document.getElementById('in-offset').value);
            cfg.cal = parseFloat(document.getElementById('in-cal').value);
            localStorage.setItem('cali_v2_cfg', JSON.stringify(cfg));
            document.getElementById('configModal').style.display = "none";
            updateUIStrings();
            log("Settings updated.");
        }

        navigator.serial.addEventListener('disconnect', () => {
            alert("Hardware Disconnected! Please check USB cable and refresh.");
            location.reload();
        });
    </script>
</body>
</html>
