<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Califonix | Industrial Data Hub</title>
    <style>
        :root { --bg: #0c0c0c; --pass: #1b5e20; --fail: #b71c1c; --mac: #00ff00; --accent: #3498db; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #000; color: white; text-align: center; margin: 0; overflow: hidden; }
        .header-bar { display: flex; justify-content: space-between; padding: 15px 40px; background: #000; border-bottom: 2px solid #222; }
        .logo { height: 60px; }
        .info-center { position: absolute; left: 50%; transform: translateX(-50%); top: 15px; text-align: center; width: 600px; }
        .model-text { font-size: 35px; font-weight: 900; color: #fff; text-transform: uppercase; margin: 0; }
        .limit-bar { font-size: 22px; color: #ffca28; background: rgba(255,202,40,0.1); padding: 5px 30px; border-radius: 50px; margin-top: 5px; border: 1px solid #ffca28; display: inline-block; }
        .theme-pass { background: var(--pass) !important; animation: blink 0.8s infinite; }
        @keyframes blink { 50% { opacity: 0.7; } }
        .theme-low { background: #e67e22 !important; } .theme-high { background: var(--fail) !important; } 
        #view { height: calc(100vh - 150px); display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .status-text { font-size: 140px; font-weight: 900; margin: 0; text-transform: uppercase; }
        .mac-display { font-size: 55px; color: var(--mac); font-family: monospace; background: #000; padding: 10px 50px; border-radius: 12px; border: 1px solid #333; margin: 15px 0; }
        .mA-display { font-size: 130px; color: var(--accent); font-weight: bold; margin: 0; }
        .stats { position: fixed; bottom: 20px; left: 20px; text-align: left; background: rgba(0,0,0,0.9); padding: 20px; border-radius: 12px; font-size: 22px; border: 1px solid #333; min-width: 250px; }
        .console { position: fixed; bottom: 20px; right: 20px; width: 350px; height: 120px; background: #111; font-family: monospace; font-size: 12px; color: #666; text-align: left; padding: 10px; overflow-y: auto; border: 1px solid #222; border-radius: 5px; }
        #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.98); z-index: 5000; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 15px; }
        .setup-btn { padding: 20px 40px; font-size: 22px; font-weight: bold; cursor: pointer; border: none; border-radius: 10px; width: 450px; color: white;}
        .modal { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#222; padding:30px; border:3px solid #fff; border-radius:15px; width: 420px; z-index: 6000; text-align: left; }
    </style>
</head>
<body id="ui-body">

    <div class="header-bar">
        <img src="https://i.postimg.cc/5y7SN4xc/logo.png" class="logo">
        <div class="info-center">
            <div id="dispModel" class="model-text">MODEL: --</div>
            <div class="limit-bar">LIMITS: <span id="dispMin">--</span> to <span id="dispMax">--</span> mA</div>
        </div>
        <div>
            <button onclick="openAdmin('config')" style="padding:10px; background:#222; color:white; border:1px solid #444; cursor:pointer; border-radius:5px;">⚙️ CONFIG</button>
        </div>
    </div>

    <div id="overlay">
        <h1 style="color:#fff;">CALIFONIX PRODUCTION STATION</h1>
        <button id="btnESP" class="setup-btn" style="background:#e67e22;" onclick="connectESP()">1. CONNECT CURRENT SENSOR</button>
        <button id="btnBB" class="setup-btn" style="background:cyan; color: black; display:none;" onclick="connectBB()">2. CONNECT MAC BOX</button>
        <button id="btnPath" class="setup-btn" style="background:#2ecc71; display:none;" onclick="setupFolder()">3. ACTIVATE LOCAL LOGGING</button>
        <p id="pathStatus" style="color:#666; margin-top:10px;">Manager password required for Step 3.</p>
    </div>

    <div id="view">
        <div id="status" class="status-text">READY</div>
        <div id="mac" class="mac-display">--:--:--:--:--:--</div>
        <div id="current" class="mA-display">0.0 mA</div>
    </div>

    <div class="stats">
        <b>PRODUCTION LOG</b><hr>
        TOTAL: <span id="s-total">0</span> | PASS: <span id="s-pass" style="color:#2ecc71">0</span> | FAIL: <span id="s-fail" style="color:#ff4d4d">0</span>
    </div>

    <div id="console" class="console">System Ready...<br></div>

    <div id="panelConfig" class="modal">
        <h2>Admin Settings</h2>
        <label>Model Name:</label><input id="in-model" style="width:100%; padding:10px; margin-bottom:10px; background:#333; color:#fff; border:1px solid #555;">
        <label>Min mA:</label><input id="in-min" type="number" style="width:100%; padding:10px; margin-bottom:10px; background:#333; color:#fff; border:1px solid #555;">
        <label>Max mA:</label><input id="in-max" type="number" style="width:100%; padding:10px; margin-bottom:10px; background:#333; color:#fff; border:1px solid #555;">
        <label>Offset:</label><input id="in-offset" type="number" style="width:100%; padding:10px; margin-bottom:10px; background:#333; color:#fff; border:1px solid #555;">
        <button onclick="saveAdmin()" style="width:100%; padding:15px; background:green; color:white; font-weight:bold; border:none; cursor:pointer;">SAVE & LOCK</button>
    </div>

    <script>
        let espPort, bbPort, dirHandle, locked = false, testing = false;
        let cfg = { model: "Boat 161", min: 30, max: 80, offset: 128.0 };
        let counts = { total: 0, pass: 0, fail: 0 }, liveMA = 0, liveMAC = "--:--:--:--:--:--";

        window.onload = () => {
            let saved = localStorage.getItem('cali_vfinal_fix');
            if(saved) { cfg = JSON.parse(saved); updateUIHeader(); }
        };

        async function connectESP() {
            try {
                espPort = await navigator.serial.requestPort(); await espPort.open({ baudRate: 115200 });
                document.getElementById('btnBB').style.display = "block";
                print("ESP32 Connected.");
            } catch (e) { print("ESP Error: " + e.message); }
        }

        async function connectBB() {
            try {
                bbPort = await navigator.serial.requestPort(); await bbPort.open({ baudRate: 460800 });
                document.getElementById('btnPath').style.display = "block";
                print("Blue Box Connected.");
            } catch (e) { print("Blue Box Error: " + e.message); }
        }

        async function setupFolder() {
            if(prompt("Manager Password:") !== "admin789") return;
            try {
                dirHandle = await window.showDirectoryPicker();
                // CRITICAL FIX: Request Read/Write permission explicitly
                if ((await dirHandle.requestPermission({ mode: 'readwrite' })) === 'granted') {
                    document.getElementById('overlay').style.display = "none";
                    print("Folder Ready: " + dirHandle.name);
                    readESP(); readBB();
                }
            } catch (e) { print("Folder Error: " + e.message); }
        }

        async function readESP() {
            const decoder = new TextDecoder();
            while (espPort.readable) {
                const reader = espPort.readable.getReader();
                try {
                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;
                        let text = decoder.decode(value);
                        if (text.includes("C|")) {
                            liveMA = parseFloat(text.split("|")[1]) - cfg.offset;
                            if (liveMA < 1) liveMA = 0;
                            if (!locked) {
                                document.getElementById('current').innerText = liveMA.toFixed(1) + " mA";
                                if (liveMA > 10.0 && !testing && liveMAC !== "--:--:--:--:--:--") startTest();
                            }
                            if (liveMA < 5.0 && (locked || testing)) resetUI();
                        }
                    }
                } finally { reader.releaseLock(); }
            }
        }

        async function readBB() {
            const reader = bbPort.readable.getReader(); let buffer = [];
            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                value.forEach(b => buffer.push(b));
                while (buffer.length >= 8) {
                    let idx = buffer.indexOf(0x06);
                    if (idx !== -1 && buffer[idx+1] === 0x01 && buffer.length >= idx + 8) {
                        liveMAC = buffer.slice(idx+2, idx+8).map(b => b.toString(16).padStart(2, '0').toUpperCase()).join(":");
                        if(!locked) document.getElementById('mac').innerText = liveMAC;
                        buffer.splice(0, idx + 8);
                    } else if (idx === -1) { buffer = []; break; }
                    else { buffer.shift(); }
                }
            }
        }

        function startTest() {
            testing = true;
            document.getElementById('status').innerText = "CAPTURING...";
            // 1 SECOND HIGH SPEED CAPTURE
            setTimeout(async () => {
                if (liveMA < 10.0) { testing = false; return; }
                locked = true;
                let finalVal = liveMA; let finalMac = liveMAC;
                let status = (finalVal < cfg.min) ? "LOW mA" : (finalVal > cfg.max ? "HIGH mA" : "PASS");
                let theme = (status === "PASS") ? "theme-pass" : (status === "LOW mA" ? "theme-low" : "theme-high");
                
                document.getElementById('status').innerText = status;
                document.getElementById('ui-body').className = theme;
                
                counts.total++; if(status === "PASS") counts.pass++; else counts.fail++;
                updateStatsUI();
                await saveToFile(cfg.model, finalMac, finalVal.toFixed(1), status);
            }, 1000); 
        }

        async function saveToFile(mod, mac, cur, st) {
            if (!dirHandle) return;
            try {
                const today = new Date().toISOString().split('T')[0];
                const fileName = `Production_Log_${today}.csv`;
                const fileHandle = await dirHandle.getFileHandle(fileName, { create: true });
                const writable = await fileHandle.createWritable({keepExistingData: true});
                const file = await fileHandle.getFile();
                
                let header = (file.size === 0) ? "Date,Time,Model,MAC,mA,Status\n" : "";
                const now = new Date();
                const row = `${header}${now.toLocaleDateString()},${now.toLocaleTimeString()},${mod},${mac},${cur},${st}\n`;
                
                await writable.write({ type: 'write', position: file.size, data: row });
                await writable.close(); // Forces physical save to drive
                print("DATA SAVED: " + mac);
            } catch (e) { print("SAVE ERROR: " + e.message); }
        }

        function resetUI() {
            testing = false; locked = false; liveMAC = "--:--:--:--:--:--";
            document.getElementById('ui-body').className = "";
            document.getElementById('dispStatus').innerText = "READY";
            document.getElementById('current').innerText = "0.0 mA";
            document.getElementById('mac').innerText = "--:--:--:--:--:--";
        }

        function updateStatsUI() {
            document.getElementById('s-total').innerText = counts.total;
            document.getElementById('s-pass').innerText = counts.pass;
            document.getElementById('s-fail').innerText = counts.fail;
        }

        function print(m) {
            const c = document.getElementById('console');
            c.innerHTML += `> ${m}<br>`;
            c.scrollTop = c.scrollHeight;
        }

        function openAdmin() { if(prompt("Password:") === "admin123") {
            document.getElementById('in-model').value = cfg.model;
            document.getElementById('in-min').value = cfg.min;
            document.getElementById('in-max').value = cfg.max;
            document.getElementById('in-offset').value = cfg.offset;
            document.getElementById('panelConfig').style.display = "block";
        }}

        function saveAdmin() {
            cfg.model = document.getElementById('in-model').value;
            cfg.min = parseFloat(document.getElementById('in-min').value);
            cfg.max = parseFloat(document.getElementById('in-max').value);
            cfg.offset = parseFloat(document.getElementById('in-offset').value);
            localStorage.setItem('cali_v50', JSON.stringify(cfg));
            document.getElementById('panelConfig').style.display = "none";
            updateUIHeader();
        }

        function updateUIHeader() {
            document.getElementById('dispModel').innerText = "MODEL: " + cfg.model;
            document.getElementById('dispMin').innerText = cfg.min;
            document.getElementById('dispMax').innerText = cfg.max;
        }
    </script>
</body>
</html>
