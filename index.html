<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Califonix | Industrial High-Speed Tester</title>
    <style>
        :root { --bg: #0c0c0c; --pass: #1b5e20; --fail: #b71c1c; --mac: #00ff00; --accent: #3498db; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #000; color: white; text-align: center; margin: 0; overflow: hidden; }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 10px 40px; background: #000; border-bottom: 2px solid #222; }
        .logo { height: 60px; }
        
        #view { height: calc(100vh - 120px); display: flex; flex-direction: column; justify-content: center; align-items: center; }
        
        /* RESULT ANIMATIONS */
        .theme-pass { background: var(--pass) !important; animation: blink 0.8s infinite; }
        @keyframes blink { 50% { opacity: 0.7; } }
        .theme-low { background: #e67e22 !important; } 
        .theme-high { background: var(--fail) !important; } 

        .status-text { font-size: 140px; font-weight: 900; margin: 0; text-transform: uppercase; line-height: 1; }
        .mac-display { font-size: 55px; color: var(--mac); font-family: monospace; background: #000; padding: 10px 50px; border-radius: 12px; border: 1px solid #333; margin: 15px 0; }
        
        .mA-display { font-size: 110px; color: var(--accent); font-weight: bold; margin: 0; }
        .amp-display { font-size: 35px; color: #888; margin-top: -10px; margin-bottom: 10px; }
        
        .timer-box { font-size: 32px; color: #ffca28; font-family: monospace; font-weight: bold; margin-top: 15px; }
        .limit-bar { font-size: 22px; color: #ffca28; background: rgba(255,202,40,0.1); padding: 5px 30px; border-radius: 50px; margin: 10px; border: 1px solid #ffca28; display: inline-block; }
        
        .stats { position: fixed; bottom: 20px; left: 20px; text-align: left; background: rgba(0,0,0,0.9); padding: 20px; border-radius: 12px; font-size: 22px; border: 1px solid #333; min-width: 250px; }
        .admin-controls { position: fixed; top: 10px; right: 10px; display: flex; gap: 10px; z-index: 5000; }
        .adm-btn { padding: 8px 15px; background: #222; border: 1px solid #444; color: #888; cursor: pointer; border-radius: 5px; font-size: 14px; }
        .modal { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#222; padding:30px; border:3px solid #fff; border-radius:15px; width: 420px; z-index: 6000; text-align: left; }
        input { width: 95%; padding: 10px; margin-bottom: 10px; background: #333; color: white; border: 1px solid #555; border-radius: 5px; }
        
        #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.98); z-index: 4000; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 15px; }
        .setup-btn { padding: 20px 40px; font-size: 22px; font-weight: bold; cursor: pointer; border: none; border-radius: 10px; width: 450px; color: white;}
    </style>
</head>
<body id="ui-body">

    <div class="header">
        <img src="https://i.postimg.cc/5y7SN4xc/logo.png" class="logo">
        <div style="text-align: right;">
            <div id="dispModel" style="font-size: 28px; font-weight: 900;">MODEL: --</div>
            <div id="dispLimits" class="limit-bar">LIMITS: -- to -- mA</div>
        </div>
    </div>

    <!-- CONNECTION SCREEN -->
    <div id="overlay">
        <h1 style="color:#fff; margin-bottom:20px;">CALIFONIX PRODUCTION STATION</h1>
        <button id="btnESP" class="setup-btn" style="background:#e67e22;" onclick="connectESP()">1. CONNECT CURRENT SENSOR (ESP32)</button>
        <button id="btnBB" class="setup-btn" style="background:cyan; color: black; display:none;" onclick="connectBB()">2. CONNECT MAC BOX (BLUE BOX)</button>
        <button id="btnPath" class="setup-btn" style="background:#2ecc71; display:none;" onclick="setupFolder()">3. SELECT LOCAL LOGS FOLDER</button>
    </div>

    <div id="view">
        <div id="mac" class="mac-display">--:--:--:--:--:--</div>
        <div id="dispCurrent" class="mA-display">0.0 mA</div>
        <div id="dispAmp" class="amp-display">0.000 Amp</div>
        <div id="status" class="status-text">READY</div>
        <div id="timer" class="timer-box">PROCESS TIME: 0.0s</div>
    </div>

    <div class="stats">
        <b>SHIFT PERFORMANCE</b><hr>
        TOTAL: <span id="s-total" style="float:right;">0</span><br>
        PASS: <span id="s-pass" style="color:#2ecc71; float:right;">0</span><br>
        FAIL: <span id="s-fail" style="color:#ff4d4d; float:right;">0</span>
    </div>

    <div class="admin-controls">
        <button class="adm-btn" onclick="openAdmin()">‚öôÔ∏è SETTINGS</button>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="panelConfig" class="modal">
        <h2 style="color: var(--accent);">System Calibration</h2>
        <label>Model Name:</label><input id="in-model">
        <label>Min mA:</label><input id="in-min" type="number">
        <label>Max mA:</label><input id="in-max" type="number">
        <label>Current Offset (Zeroing):</label><input id="in-offset" type="number">
        <label>Calibration Factor:</label><input id="in-cal" type="number" step="0.001">
        <button onclick="saveAdmin()" style="width:100%; padding:15px; background:green; color:white; font-weight:bold; border:none; cursor:pointer; border-radius:5px;">SAVE & APPLY</button>
    </div>

    <script>
        let espPort, bbPort, dirHandle, locked = false, testing = false;
        let cfg = { model: "Boat 161", min: 30, max: 80, offset: 128.0, cal: 0.814 };
        let counts = { total: 0, pass: 0, fail: 0 }, liveMA = 0, liveMAC = "--:--:--:--:--:--";
        let startTime, timerInterval;

        // 1. DISCONNECT ALERT POPUP
        navigator.serial.addEventListener('disconnect', (e) => {
            alert("üö® HARDWARE DISCONNECTED!\nUSB Port nikal gaya hai. Port check karein aur page Refresh karein.");
            location.reload();
        });

        window.onload = () => {
            let saved = localStorage.getItem('cali_master_v60');
            if(saved) { cfg = JSON.parse(saved); updateUIHeader(); }
        };

        async function connectESP() {
            try { espPort = await navigator.serial.requestPort(); await espPort.open({ baudRate: 115200 }); document.getElementById('btnBB').style.display = "block"; } catch (e) {}
        }
        async function connectBB() {
            try { bbPort = await navigator.serial.requestPort(); await bbPort.open({ baudRate: 460800 }); document.getElementById('btnPath').style.display = "block"; } catch (e) {}
        }
        async function setupFolder() {
            try {
                dirHandle = await window.showDirectoryPicker();
                if ((await dirHandle.requestPermission({ mode: 'readwrite' })) === 'granted') {
                    document.getElementById('overlay').style.display = "none";
                    readESP(); readBB();
                }
            } catch (e) { alert("Folder access required!"); }
        }

        async function readESP() {
            const decoder = new TextDecoder();
            while (espPort.readable) {
                const reader = espPort.readable.getReader();
                try {
                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;
                        let text = decoder.decode(value);
                        if (text.includes("C|")) {
                            let raw = parseFloat(text.split("|")[1]);
                            // APPLY CALIBRATION
                            liveMA = (raw - cfg.offset) * cfg.cal;
                            if (liveMA < 2) liveMA = 0;
                            
                            // AUTO RESET ON REMOVAL
                            if (liveMA < 5.0 && (locked || testing)) resetUI();

                            if (!locked) {
                                document.getElementById('current').innerText = liveMA.toFixed(1) + " mA";
                                document.getElementById('dispAmp').innerText = (liveMA / 1000).toFixed(3) + " Amp";
                                
                                // TRIGGER: Start timer on Current Detect
                                if (liveMA > 10.0 && !testing) startProductionTest();
                            }
                        }
                    }
                } finally { reader.releaseLock(); }
            }
        }

        async function readBB() {
            const reader = bbPort.readable.getReader(); let buffer = [];
            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                value.forEach(b => buffer.push(b));
                while (buffer.length >= 8) {
                    let idx = buffer.indexOf(0x06);
                    if (idx !== -1 && buffer[idx+1] === 0x01 && buffer.length >= idx + 8) {
                        liveMAC = buffer.slice(idx+2, idx+8).map(b => b.toString(16).padStart(2, '0').toUpperCase()).join(":");
                        if(!locked) {
                            document.getElementById('mac').innerText = liveMAC;
                            // MAC FOUND -> If testing, complete the result
                            if (testing) finalizeResult();
                        }
                        buffer.splice(0, idx + 8);
                    } else if (idx === -1) { buffer = []; break; }
                    else { buffer.shift(); }
                }
            }
        }

        function startProductionTest() {
            testing = true;
            startTime = Date.now();
            document.getElementById('status').innerText = "WAITING FOR MAC...";
            
            // START DISPLAY TIMER
            timerInterval = setInterval(() => {
                let elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
                document.getElementById('timer').innerText = `PROCESS TIME: ${elapsed}s`;
                // FAIL IF NO MAC IN 5 SECONDS
                if (elapsed > 5.0) { finalizeResult(); }
            }, 100);
        }

        async function finalizeResult() {
            clearInterval(timerInterval);
            if (locked) return;
            locked = true;
            
            let finalVal = liveMA;
            let finalMac = liveMAC;
            let status = "PASS", theme = "theme-pass";

            // CONDITION: No result without MAC
            if (finalMac === "--:--:--:--:--:--") { status = "FAIL (NO MAC)"; theme = "theme-high"; }
            else if (finalVal < cfg.min) { status = "LOW CURRENT"; theme = "theme-low"; }
            else if (finalVal > cfg.max) { status = "HIGH CURRENT"; theme = "theme-high"; }
            
            document.getElementById('status').innerText = status;
            document.getElementById('ui-body').className = theme;
            
            if(status === "PASS") counts.pass++; else counts.fail++;
            counts.total++;
            updateStatsUI();
            await saveToCSV(cfg.model, finalMac, finalVal.toFixed(1), status);
        }

        async function saveToCSV(mod, mac, cur, st) {
            if (!dirHandle) return;
            const fileName = `Log_${new Date().toISOString().split('T')[0]}.csv`;
            const fileH = await dirHandle.getFileHandle(fileName, { create: true });
            const writable = await fileH.createWritable({keepExistingData: true});
            const file = await fileH.getFile();
            let header = (file.size === 0) ? "Date,Time,Model,MAC,Amp,mA,Status\n" : "";
            const now = new Date();
            const row = `${header}${now.toLocaleDateString()},${now.toLocaleTimeString()},${mod},${mac},${(cur/1000).toFixed(3)},${cur},${st}\n`;
            await writable.write({ type: 'write', position: file.size, data: row });
            await writable.close();
        }

        function resetUI() {
            clearInterval(timerInterval);
            testing = false; locked = false; liveMAC = "--:--:--:--:--:--";
            document.getElementById('ui-body').className = "";
            document.getElementById('dispStatus').innerText = "READY";
            document.getElementById('dispCurrent').innerText = "0.0 mA";
            document.getElementById('dispAmp').innerText = "0.000 Amp";
            document.getElementById('mac').innerText = "--:--:--:--:--:--";
            document.getElementById('timer').innerText = "PROCESS TIME: 0.0s";
        }

        function updateStatsUI() {
            document.getElementById('s-total').innerText = counts.total;
            document.getElementById('s-pass').innerText = counts.pass;
            document.getElementById('s-fail').innerText = counts.fail;
        }

        function openAdmin() {
            document.getElementById('in-model').value = cfg.model;
            document.getElementById('in-min').value = cfg.min;
            document.getElementById('in-max').value = cfg.max;
            document.getElementById('in-offset').value = cfg.offset;
            document.getElementById('in-cal').value = cfg.cal;
            document.getElementById('panelConfig').style.display = "block";
        }

        function saveAdmin() {
            cfg.model = document.getElementById('in-model').value;
            cfg.min = parseFloat(document.getElementById('in-min').value);
            cfg.max = parseFloat(document.getElementById('in-max').value);
            cfg.offset = parseFloat(document.getElementById('in-offset').value);
            cfg.cal = parseFloat(document.getElementById('in-cal').value);
            localStorage.setItem('cali_master_v60', JSON.stringify(cfg));
            document.getElementById('panelConfig').style.display = "none";
            updateUIHeader();
        }

        function updateUIHeader() {
            document.getElementById('dispModel').innerText = "MODEL: " + cfg.model;
            document.getElementById('dispMin').innerText = cfg.min;
            document.getElementById('dispMax').innerText = cfg.max;
        }
    </script>
</body>
</html>
