
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Califonix | Industrial Master Hub</title>
    <style>
        :root { --bg: #000; --pass: #1b5e20; --fail: #b71c1c; --mac: #00ff00; --accent: #00f2ff; }
        body { font-family: 'Segoe UI', sans-serif; background: #000; color: white; text-align: center; margin: 0; overflow: hidden; }
        
        .header { display: flex; justify-content: space-between; align-items: center; padding: 10px 40px; background: #050505; border-bottom: 2px solid #111; position: relative; }
        .logo { height: 60px; }
        .info-center { position: absolute; left: 50%; transform: translateX(-50%); top: 10px; text-align: center; }
        .model-text { font-size: 35px; font-weight: 900; color: #fff; text-transform: uppercase; margin: 0; }
        .limit-bar { font-size: 20px; color: #ffca28; background: rgba(255, 202, 40, 0.1); padding: 5px 30px; border-radius: 50px; border: 1px solid #ffca28; margin-top: 5px; display: inline-block; }

        /* THEMES */
        .theme-pass { background: var(--pass) !important; animation: blink 0.8s infinite; }
        @keyframes blink { 50% { opacity: 0.7; } }
        .theme-low { background: #e67e22 !important; } 
        .theme-high { background: var(--fail) !important; } 

        #view { height: calc(100vh - 140px); display: flex; flex-direction: column; justify-content: center; align-items: center; transition: 0.1s; }
        .status-text { font-size: 130px; font-weight: 900; margin: 0; text-transform: uppercase; line-height: 1; }
        .mac-display { font-size: 60px; color: var(--mac); font-family: monospace; background: #000; padding: 10px 60px; border-radius: 15px; border: 1px solid #333; margin: 15px 0; min-height: 80px; }
        .mA-display { font-size: 115px; color: var(--accent); font-weight: bold; margin: 0; }
        .amp-display { font-size: 35px; color: #666; margin-top: -10px; font-weight: bold; }
        
        .timer-box { font-size: 32px; color: #ffca28; font-family: monospace; font-weight: bold; margin-top: 10px; }
        .stats { position: fixed; bottom: 20px; left: 20px; text-align: left; background: #080808; padding: 20px; border-radius: 12px; font-size: 22px; border: 1px solid #222; min-width: 250px; }
        
        /* OVERLAY & MODAL */
        #overlay { position: fixed; inset: 0; background: #000; z-index: 4000; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 15px; }
        .setup-btn { padding: 20px 40px; font-size: 22px; font-weight: bold; cursor: pointer; border: none; border-radius: 10px; width: 450px; color: white;}
        .modal { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#0a0a0a; padding:30px; border:1px solid #fff; border-radius:15px; width: 420px; z-index: 6000; text-align: left; }
        input { width: 95%; padding: 12px; margin-bottom: 10px; background: #111; color: white; border: 1px solid #333; border-radius: 5px; }
    </style>
</head>
<body id="ui-body">
    <div class="header">
        <img src="https://i.postimg.cc/5y7SN4xc/logo.png" class="logo">
        <div class="info-center">
            <div id="dispModel" class="model-text">MODEL: --</div>
            <div class="limit-bar">TARGET: <span id="dispMin">--</span> to <span id="dispMax">--</span> mA</div>
        </div>
        <button onclick="openConfig()" style="background:#111; border:1px solid #333; color:#555; cursor:pointer; padding:5px 10px; border-radius:5px;">SETTINGS</button>
    </div>

    <div id="overlay">
        <img src="https://i.postimg.cc/5y7SN4xc/logo.png" style="height:100px; margin-bottom:30px;">
        <button id="btnESP" class="setup-btn" style="background:#e67e22;" onclick="connectESP()">1. CONNECT CURRENT STATION (ESP32)</button>
        <button id="btnBB" class="setup-btn" style="background:cyan; color:black; display:none;" onclick="connectBB()">2. CONNECT MAC STATION (BLUE BOX)</button>
        <button id="btnPath" class="setup-btn" style="background:#2ecc71; display:none;" onclick="setupFolder()">3. SELECT LOGS FOLDER (D:/Drive)</button>
    </div>

    <div id="view">
        <div id="mac" class="mac-display">-- : -- : -- : -- : -- : --</div>
        <div id="dispCurrent" class="mA-display">0.0 mA</div>
        <div id="dispAmp" class="amp-display">0.000 Amp</div>
        <div id="status" class="status-text">READY</div>
        <div id="timer" class="timer-box">PROCESS TIME: 0.0s</div>
    </div>

    <div class="stats">
        PASS: <span id="s-pass" style="color:#2ecc71">0</span> | FAIL: <span id="s-fail" style="color:#ff4d4d">0</span> | TOT: <span id="s-total">0</span>
    </div>

    <div id="panelConfig" class="modal">
        <h3>Industrial Config</h3>
        <label>Model Name:</label><input id="in-model">
        <label>Min mA:</label><input id="in-min" type="number">
        <label>Max mA:</label><input id="in-max" type="number">
        <label>Zero Offset:</label><input id="in-offset" type="number">
        <label>Calibration Factor:</label><input id="in-cal" type="number" step="0.001">
        <button onclick="saveAdmin()" style="width:100%; padding:15px; background:green; color:white; font-weight:bold; border:none; cursor:pointer;">SAVE & APPLY</button>
    </div>

    <script>
        let espPort, bbPort, dirHandle, locked = false, testing = false, macStepDone = false;
        let cfg = { model: "Boat 161", min: 30, max: 80, offset: 128.0, cal: 0.791 };
        let counts = { total: 0, pass: 0, fail: 0 }, liveMA = 0, liveMAC = "-- : -- : -- : -- : -- : --";
        let startTime, timerInterval;

        // 1. DISCONNECT ALERT POPUP
        navigator.serial.addEventListener('disconnect', (e) => {
            alert("ðŸš¨ HARDWARE DISCONNECTED!\nUSB Port nikal gaya hai. Refresh karke dobara connect karein.");
            location.reload();
        });

        window.onload = () => {
            let saved = localStorage.getItem('cali_sys_final_v1000');
            if(saved) { cfg = JSON.parse(saved); updateUIHeader(); }
        };

        async function connectESP() {
            try { espPort = await navigator.serial.requestPort(); await espPort.open({ baudRate: 115200 }); document.getElementById('btnBB').style.display = "block"; } catch (e) {}
        }
        async function connectBB() {
            try { bbPort = await navigator.serial.requestPort(); await bbPort.open({ baudRate: 460800 }); document.getElementById('btnPath').style.display = "block"; } catch (e) {}
        }
        async function setupFolder() {
            try {
                dirHandle = await window.showDirectoryPicker();
                if ((await dirHandle.requestPermission({ mode: 'readwrite' })) === 'granted') {
                    document.getElementById('overlay').style.display = "none";
                    readESP(); readBB();
                }
            } catch (e) {}
        }

        async function readESP() {
            const decoder = new TextDecoder();
            while (espPort.readable) {
                const reader = espPort.readable.getReader();
                try {
                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;
                        let text = decoder.decode(value);
                        if (text.includes("C|")) {
                            let raw = parseFloat(text.split("|")[1]);
                            liveMA = (raw - cfg.offset) * cfg.cal;
                            if (liveMA < 2) liveMA = 0;

                            // 2. INSTANT RESET Logic: Jump to READY when removed
                            if (liveMA < 5.0 && (locked || testing)) {
                                resetUI();
                            }

                            if (!locked) {
                                document.getElementById('dispCurrent').innerText = liveMA.toFixed(1) + " mA";
                                document.getElementById('dispAmp').innerText = (liveMA / 1000).toFixed(3) + " Amp";
                                if (liveMA > 10.0 && !testing) startSequence();
                            }
                        }
                    }
                } finally { reader.releaseLock(); }
            }
        }

        async function readBB() {
            const reader = bbPort.readable.getReader(); let buffer = [];
            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                value.forEach(b => buffer.push(b));
                // High-Speed Packet Buffer Cleaning
                if (buffer.length > 50) buffer = buffer.slice(-20); 

                while (buffer.length >= 8) {
                    let idx = buffer.indexOf(0x06);
                    if (idx !== -1 && buffer[idx+1] === 0x01 && buffer.length >= idx + 8) {
                        let mac = buffer.slice(idx+2, idx+8).map(b => b.toString(16).padStart(2, '0').toUpperCase()).join(":");
                        if(!locked) {
                            liveMAC = mac;
                            document.getElementById('mac').innerText = liveMAC;
                        }
                        buffer.splice(0, idx + 8);
                    } else if (idx === -1) { buffer = []; break; }
                    else { buffer.shift(); }
                }
            }
        }

        function startSequence() {
            testing = true;
            startTime = Date.now();
            document.getElementById('status').innerText = "FETCHING MAC...";
            timerInterval = setInterval(() => {
                let elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
                document.getElementById('timer').innerText = `PROCESS TIME: ${elapsed}s`;
                // Requirement: 2-second capture window after detection
                if (elapsed >= 2.0 && !locked) {
                    clearInterval(timerInterval);
                    finalizeResult();
                }
            }, 100);
        }

        async function finalizeResult() {
            if (locked) return;
            locked = true;
            let status = (liveMA >= cfg.min && liveMA <= cfg.max) ? "PASS" : (liveMA < cfg.min ? "LOW mA" : "HIGH mA");
            
            // Final Verdict: No MAC = Fail
            if (liveMAC === "-- : -- : -- : -- : -- : --") status = "FAIL (NO MAC)";
            
            document.getElementById('status').innerText = status;
            document.getElementById('ui-body').className = (status === "PASS") ? "theme-pass" : "theme-high";
            
            counts.total++; if(status === "PASS") counts.pass++; else counts.fail++;
            updateStatsUI();
            await saveToLog(cfg.model, liveMAC, liveMA.toFixed(1), status);
        }

        async function saveToLog(mod, mac, cur, st) {
            if (!dirHandle) return;
            try {
                const today = new Date().toISOString().split('T')[0];
                const fileName = `Report_${today}.csv`;
                const fileH = await dirHandle.getFileHandle(fileName, { create: true });
                const writable = await fileH.createWritable({keepExistingData: true});
                const file = await fileH.getFile();
                let header = (file.size === 0) ? "Date,Time,Model,MAC,Current,Status\n" : "";
                const row = `${header}${new Date().toLocaleDateString()},${new Date().toLocaleTimeString()},${mod},${mac},${cur},${st}\n`;
                await writable.write({ type: 'write', position: file.size, data: row });
                await writable.close();
            } catch (e) {}
        }

        function resetUI() {
            clearInterval(timerInterval);
            testing = false; locked = false;
            liveMAC = "-- : -- : -- : -- : -- : --";
            document.getElementById('ui-body').className = "";
            document.getElementById('status').innerText = "READY";
            document.getElementById('mac').innerText = liveMAC;
            document.getElementById('timer').innerText = "PROCESS TIME: 0.0s";
        }

        function updateStatsUI() {
            document.getElementById('s-total').innerText = counts.total;
            document.getElementById('s-pass').innerText = counts.pass;
            document.getElementById('s-fail').innerText = counts.fail;
        }

        function openAdmin() {
            document.getElementById('in-model').value = cfg.model;
            document.getElementById('in-min').value = cfg.min;
            document.getElementById('in-max').value = cfg.max;
            document.getElementById('in-offset').value = cfg.offset;
            document.getElementById('in-cal').value = cfg.cal;
            document.getElementById('panelConfig').style.display = "block";
        }

        function saveAdmin() {
            cfg.model = document.getElementById('in-model').value;
            cfg.min = parseFloat(document.getElementById('in-min').value);
            cfg.max = parseFloat(document.getElementById('in-max').value);
            cfg.offset = parseFloat(document.getElementById('in-offset').value);
            cfg.cal = parseFloat(document.getElementById('in-cal').value);
            localStorage.setItem('cali_sys_final_v1000', JSON.stringify(cfg));
            document.getElementById('panelConfig').style.display = "none";
            updateUIHeader();
        }

        function updateUIHeader() {
            document.getElementById('dispModel').innerText = "MODEL: " + cfg.model;
            document.getElementById('dispMin').innerText = cfg.min;
            document.getElementById('dispMax').innerText = cfg.max;
        }
    </script>
</body>
</html>
